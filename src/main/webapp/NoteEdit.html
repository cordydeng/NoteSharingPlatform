<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="./static/css/Note/note_page.css" />
    <link rel="stylesheet" href="./static/css/Note/styleguide.css" />

    <script src="https://code.jquery.com/jquery-1.12.4.js"
        integrity="sha256-Qw82+bXyGq6MydymqBxNPYTaUXXq7c8v3CwiYwLLNXU=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
</head>

<body>

    <header>
        <div
            style="width: 100vw; height: 10vh; padding-left: 5vh; display: flex; flex-direction: row; align-items: center; background-color: #54AABB;">
            <button style="border: none; background-color: transparent; cursor: pointer;"><img
                    style="width: 8vh; height: 8vh;" src="./static/icon/material-symbols-chevron-left.png"></button>
        </div>
    </header>

    <div class="desktop">


        <!-- 左側區域 -->
        <div style=" width: 62.5vw; height: 90vh; display: flex; flex-direction: column;">
            <!-- 圖片區 -->
            <div
                style="width: 62.5vw; height: 80vh; background-color: #F5F5F5; overflow: auto; display: flex; flex-direction: column; align-items: center;">

                <div id="imageContainer" style="display: flex; flex-wrap: wrap; align-items: center;"></div>
                <script>

                </script>
            </div>
            <!-- 數據欄 -->
            <div
                style="width: 62.5vw; height: 10vh; display: flex; flex-direction: row; justify-content: center; align-items: center; background-color: #F5F5F5;">
            </div>
        </div>

        <!-- 右側資訊 -->
        <div
            style="width: 37.5vw; height: 90vh; background-color: #f5f5f5; border-left: 3px solid #000000; display: flex; flex-direction: column; justify-content: space-between; align-items: center; overflow-x: hidden;">
            <!-- 筆記資訊 -->
            <div
                style="width: 37.5vw; height: 70vh;  display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <div class="view-wrapper">
                    <div class="view" style="overflow: visible;">
                        <div class="dropdown">
                            <input type="button" id="dropbtn" onclick="myFunction()" class="dropbtn" value="標籤選單">
                            <div id="myDropdown" class="dropdown-content">
                                <div onclick="select()">#行銷學</div>
                                <div onclick="select()">#系統分析與設計</div>
                                <div onclick="select()">#組織行為</div>
                                <div onclick="select()">#作業研究</div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="form-check form-switch" style="margin-left:auto; right: 40px; position: relative;">
                    <input class="form-check-input" type="checkbox" id="public_btn" checked>
                    <label class="form-check-label" for="public_btn">公開</label>
                </div>

                <textarea class="topic-text" style="width: 32vw; height: 35px; background-color: #f5f5f5; margin-top: 4vh; font-size: 20px; font-weight: bold; color: #000000; letter-spacing: 0; resize: none; max-lines: 1; border-style:none; border-bottom-style: solid;
        text-align: left; " id="note_topic" name="note_topic" placeholder="筆記名稱*" value=""></textarea>

                <textarea class="topic-text" id="note_info" name="note_info"
                    style="width: 32vw; height: 32vh; resize: none; background-color: #f5f5f5;  resize: none; margin-top: 4vh; margin-bottom: 4vh; border-style:none;"
                    placeholder="筆記簡介"></textarea>



            </div>
            <!-- 功能按鈕 -->
            <div style="display: flex; flex-direction: row; gap: 8px; height: 15vh; align-items: center;">
                <button class="uploadbtn"
                    style="width: 12vw; height: 6vh; border-radius: 2vw; font-size: 16px; color: #ffffff; background-color: #D9D9D9; font-weight: bold; border-style: none;"
                    id="update">更新</button>
                <button class="uploadbtn"
                    style="width: 12vw; height: 6vh; border-radius: 2vw; font-size: 16px; color: #ffffff; background-color: #eea4a4; font-weight: bold; border-style: none;"
                    id="delete">刪除</button>
            </div>

        </div>

    </div>
</body>

<script>
    var isPublic = 1;

    function public() {
        if (document.getElementById('public_btn').checked) {
            // Public (1)  
            isPublic = 1;
        }
        else {
            // Private (0)
            isPublic = 0;
        }
    }
    /* When the user clicks on the button,
    toggle between hiding and showing the dropdown content */
    function myFunction() {
        document.getElementById("myDropdown").classList.toggle("show");
    }

    // Close the dropdown menu if the user clicks outside of it
    window.onclick = function (event) {
        if (!event.target.matches('.dropbtn')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            var i;
            for (i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    }

    //get the selected value of dropdown content
    function select() {
        var myDropdown = document.getElementById('myDropdown');
        myDropdown.addEventListener('click', function (e) {
            if (e.target.tagName.toLowerCase() === 'div') {
                console.log(e.target.textContent);
                document.getElementById('dropbtn').value = e.target.textContent;
            }

        }, false);
    }

</script>
<script type="text/javascript">
    //const currentUser = Cookies.get('storedEmail');
    const currentUser = "a";
    console.log('Cookie User: ' + currentUser);

    //test
    const notesData = [
        { Account: "John Doe", NoteName: "Note 1", Like: 10, Tag: "Technology", UploadTime: new Date('2023-01-01'), ID: 1, NoteDescription: "XXX" },
        { Account: "Jane Smith", NoteName: "Note 2", Like: 5, Tag: "Science", UploadTime: new Date('2023-02-15'), ID: 2, NoteDescription: "XXX" },
        // Add more notes as needed
    ];

    // 获取 URL 中的参数
    const urlParams = new URLSearchParams(window.location.search);

    // 通过参数名获取参数值
    const noteId = urlParams.get('NoteID');


    function getNoteInfo() {
        $.ajax({
            type: "GET",
            url: "api/Note.do?NoteID=" + noteId + "&Account=" + currentUser,
            crossNoteIDomain: true,
            cache: false,
            dataType: 'json',
            timeout: 5000,
            success: function (response) {
                console.log(response);
                if (response.status == 200) {
                    addNote(response.NoteInfo.NoteData[0]);
                    addPics(response.PicUrl);
                }
            },
            error: function () {
                alert("無法連線到伺服器！");
            }
        });
    }

    getNoteInfo();

    function addNote(note) {
        $("#note_topic").val(note.NoteName);
        $("#dropbtn").val(note.Tag);
        $("#note_info").val(note.NoteDescription);
        if (note.Public === 0) {
            $("#public_btn").prop('checked', false);
            isPublic = 0;
        } else {
            $("#public_btn").prop('checked', true);
            isPublic = 1;
        }

    }
    function addPics(note) {
        var files = note.PicList;
        var imageContainer = $('#imageContainer');

        for (var i = 0; i < files.length; i++) {
            var imgContainer = document.createElement('div');
            imgContainer.style.position = 'relative';

            var img = document.createElement('img');
            img.style.width = '60vw';
            img.style.height = 'auto';
            img.style.margin = '5px';
            img.src = files[i].PicURL;

            img.onload = function () {
                URL.revokeObjectURL(this.src);
            };

            imgContainer.append(img);
            imageContainer.append(imgContainer);
        }
        console.log(files);

    }

    $(document).ready(function () {
        // 處理表單點擊事件
        var $form = $('#update');
        $form.click(function () {
            public();
            update();
        });

        function update() { //筆記更新
            var NoteID = noteId;
            var Tag = $('#dropbtn').val();
            var NoteName = $('#note_topic').val();
            var NoteDescription = $('#note_info').val();
            var Public = isPublic;
            var Account = currentUser;

            console.log(Tag, NoteName, NoteDescription, Public, Account);

            if (NoteName === null || NoteName.trim() === "") { //檢查noteName是否填寫
                alert("需填寫筆記名稱！");
            }
            else {
                // 將資料組成JSON格式
                var data_object = {
                    "NoteID": NoteID,
                    "NoteName": NoteName,
                    "NoteDescription": NoteDescription,
                    "Tag": Tag,
                    "Public": Public,
                    "Account": Account
                };
            };

            // 將JSON格式轉換成字串
            var data_string = JSON.stringify(data_object);

            // 發出POST的AJAX請求
            $.ajax({
                type: "PUT",
                url: "api/Note.do?NoteID=" + noteId, // Replace with your JSON API endpoint
                data: JSON.stringify(data_object),
                contentType: 'application/json',
                success: function (response) {
                    var res = jQuery.parseJSON(response);
                    console.log(res);
                    console.log(res.status);
                    if (res.status === "200") {
                        console.log("JSON data sent successfully");
                    }
                    else {
                        console.log("shit");
                    }
                },
                error: function () {
                    console.error("Error sending JSON data");
                    console.log(data_object);
                    // Handle error if needed
                }
            });
        }
    });

    $(document).ready(function () {
        // 處理表單點擊事件
        var $form = $('#delete');
        $form.click(function () {
            deleteNote(noteId);
        });
        async function deleteNote(noteId) {
            await fetch('/SA/api/Note.do', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ NoteID: noteId }),
            }).then((response) => response.json())
                .then((data) => {
                    console.log('%c - Delete Note:' + noteId, 'color: orange');
                    window.alert(data['message'] + "<br>即將導回個人主頁");
                    window.location.href = './UserProfile.html?Account=' + currentUser;
                })
        .catch((error) => {
            console.error('Error:', error);
        });
        }
    });
    //test
    //addNote(notesData[0]);

</script>

</html>