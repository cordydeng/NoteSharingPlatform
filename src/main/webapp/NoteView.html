<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />

    <link rel="icon" type="image/x-icon" href="./static/image/logo.png">

    <link rel="stylesheet" href="./static/css/Note/note_page0.css" />
    <link rel="stylesheet" href="./static/css/Note/styleguide.css" />


    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>

    <!-- <script src="./static/js/Note/NoteView.js"></script> -->
</head>

<body>
    <header>
        <div
            style="width: 100vw; height: 10vh; padding-left: 5vh; display: flex; flex-direction: row; align-items: center; background-color: #54AABB;">
            <button style="border: none; background-color: transparent; cursor: pointer;"
                onclick="window.history.back();">
                <img style="width: 8vh; height: 8vh;" src="./static/icon/material-symbols-chevron-left.png"></button>
        </div>
    </header>

    <div class="desktop">

        <!-- Â∑¶ÂÅ¥ÂçÄÂüü -->
        <div
            style="display: flex; flex-direction: column; width: 62.5vw; height: 90vh; justify-content: center; align-items: center;">
            <!-- ÂúñÁâáÂçÄ -->

            <div
                style="width: max-content; height: 90vh; display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 1vw;">

                <div
                    style="height: 36vw;  display: flex; flex-direction: column; justify-content: space-between; align-items: center;">

                    <div style="height: 33vw; display: flex; align-items: center;">
                        <!-- Displayed Picture -->
                        <a>
                            <img id="pic-displayed" style="width: 24vw; height: 32vw;" src="" />
                        </a>
                    </div>

                    <!-- Page Display -->
                    <div
                        style="width: 16vw; height: 2vw; padding: 0.50vw; background-color: #F5F5F5; border-radius: 8vw; display: flex; justify-content: center; align-items: center;">
                        <span>Á¨¨ <span id="note-current-page">P</span> È†ÅÔºèÂÖ± <span id="note-total-page">T</span> È†Å</span>
                    </div>
                </div>


                <div
                    style="display: flex; flex-direction: column; justify-content: space-between; height: 36vw; align-items: center; background-color: #F5F5F5;">
                    <button id="btn-prev-pic" onclick="prevPicture(); "
                        style="cursor: pointer; box-sizing: border-box; width: 100%; height: 3vw; background-color: rgba(0, 0, 0, 0.25); outline: none">
                        <img style="box-sizing: border-box; height: 100%;" src="./static/icon/icons8-chevron-up-64.png">
                    </button>
                    <!-- Prev Picture -->
                    <a>
                        <img id="pic-prev" style="width: 6vw; height: 8vw; filter: brightness(0.70);" src="">
                    </a>
                    <!-- Selected Picture -->
                    <a>
                        <img id="pic-selected" style="width: 6vw; height: 8vw; border: 1vh double #000000;" src="">
                    </a>
                    <!-- Next Picture -->
                    <a>
                        <img id="pic-next" style="width: 6vw; height: 8vw; filter: brightness(0.70);" src="">
                    </a>
                    <button id="btn-next-pic" onclick="nextPicture(); "
                        style="cursor: pointer; box-sizing: border-box; width: 100%; height: 3vw; background-color: rgba(0, 0, 0, 0.25); outline: none">
                        <img style="box-sizing: border-box; height: 100%;"
                            src="./static/icon/icons8-chevron-down-64.png">
                    </button>
                </div>
            </div>
        </div>

        <!-- Âè≥ÂÅ¥Ë≥áË®ä -->
        <div
            style="width: 37.5vw; height: 90vh; background-color: #F5F5F5; border-left: 3px solid #000000; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow-x: hidden;">
            <!--‰ΩúËÄÖË≥áË®ä+Ê®ôÁ±§-->
            <div
                style="box-sizing: border-box; width: 85%;  height: auto; display: flex; flex-direction: row; justify-content: space-between; align-items: center;">
                <div style="width: auto; display: flex; justify-content: center; align-items: center; gap: 1vw; ">
                    <img id="author-pic" style="width: 4vw; height: 4vw; border-radius: 50%;" src="./static/image/no-user.png">
                    <a id="author-profile" href="" style="text-decoration: none; color: #4169E1"><h1 id="user-name" style="padding-left: 5px;" class="author_name">‰ΩúËÄÖÂêçÁ®±</h1></a>
                </div>
                <div class="category">
                    <div id="note-tag" class="categorytext">Ê®ôÁ±§</div>
                </div>
            </div>

            <!-- Á≠ÜË®òË≥áË®ä -->
            <div
                style="width: 37.5vw; height: auto;  display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <div id="note-name"
                    style="width: 32vw; height: fit-content; margin-top: 4vh; font-size: 4vh; font-weight: bold; color: #000000; letter-spacing: 0; resize: none; max-lines: 1; text-align: left;">
                    Á≠ÜË®òÂêçÁ®±
                </div>

                <div id="note-description"
                    style="width: 32vw; height: 32vh; resize: none; background-color: #D9D9D9; font-size: 20px; resize: none; margin-top: 4vh; margin-bottom: 4vh;">

                    Á≠ÜË®òÁ∞°‰ªã</div>

                <span>Êõ¥Êñ∞ÊôÇÈñì: <span id="note-upload-time">yyyy / MM / DD</span></span>

                <!-- Êï∏ÊìöÊ¨Ñ -->
                <div
                    style="width: 62.5vw; height: 10vh; display: flex; flex-direction: row; justify-content: center; align-items: center; background-color: #F5F5F5; gap: 1vw;">
                    <!-- <div class="group-2">
                        <img class="vector" src="./static/icon/simple_eye_icon.png" />
                        <div class="text-wrapper-7">999,999</div>
                    </div> -->
                    <div style="display: flex; flex-direction: row; justify-content: center; align-items: center;">
                        <img src="./static/icon/icons8-comments-64.png" style="width: 3vw; height: 3vw;" />
                        <div id="note-comment-count" style="width: 4vw; font-size: 4vh; text-align: right;">999</div>
                    </div>
                    <div
                        style="width: 10vw; display: flex; flex-direction: row; justify-content: center; align-items: center;">
                        <img id="icon-like" src="./static/icon/icons8-favorite-64.png" onclick="favorite();"
                            style="width: 3vw; height: 3vw; cursor: pointer;" />
                        <div id="note-like-count" style="width: 8vw; font-size: 4vh; text-align: right;">999,999</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÁïôË®ÄÂçÄ -->
    <div
        style="width: 100vw; height: fit-content; display: flex; flex-direction: column; align-items: center; margin: 3vh">
        <!-- ÁïôË®ÄËº∏ÂÖ•Ê°Ü -->
        <div style="width: 80vw; height: fit-content; display: flex; flex-direction: column; ">
            <div
                style="box-sizing: border-box; width: 100%; display: flex; flex-direction: row; justify-content: space-between;">
                <!-- ÁïôË®ÄÂÖßÂÆπ -->
                <textarea id="comment-input"
                    style="box-sizing: border-box; width: 90%; height: 12vh; resize: none; font-size: 4vh;"
                    placeholder="ÁïôË®ÄÂçÄ"></textarea>
                <!-- ‰∏äÂÇ≥ÊåâÈàï -->
                <button style="box-sizing: border-box; width: 10%; cursor: pointer;" onclick="addComment();">
                    <img style="box-sizing: border-box; height: 100%;" src="./static/icon/icons8-arrow-r-64.png">
                </button>
            </div>
        </div>

        <!-- ÁïôË®ÄÁ¥ÄÈåÑ -->
        <div id="comment-list" style="width: 80vw; display: flex; flex-direction: column; margin: 1vh; gap: 1vh;"></div>
    </div>

</body>
<script>
    function changeImage(imageSrc) {
        document.getElementById("mainImage").style.transform = "scale(0)";
        setTimeout(function () {
            document.getElementById("mainImage").style.backgroundImage = `url('${imageSrc}')`;
            document.getElementById("mainImage").style.transform = "scale(1)";
        }, 300);
    }
</script>

<script>
    // ÈñãÁôºÊ®°Âºè
    const api_url = '/SA/api/';

    /* -------------------------------------------------------------------------- */
    /*                                  main code                                 */
    /* -------------------------------------------------------------------------- */

    // get noteId stored in URL Parameter
    const urlParameter = new URL(window.location.toLocaleString()).searchParams;
    const noteId = urlParameter.get('NoteID');

    console.log('URL Param: ' + noteId);

    // userId in Cookie
    const currentUser = Cookies.get('storedEmail');

    // ÂúñÁâáË∑ØÂæë
    var image_root = '../FileStorage/Note/' + noteId;
    // ÂúñÁâáÂàóË°®
    var image_list = [];
    // ÂúñÁâáÈ†ÅÊï∏
    var current_page = 1;
    // Á≠ÜË®ò‰ΩúËÄÖ
    var authorId = '';

    /* ---------------------------------- Trans --------------------------------- */

    /// Âæû String Èô£ÂàóÊîπÁÇ∫ HTML
    function getHTML(template) {
        return template.join('\n');
    }

    /* --------------------------------- Onload --------------------------------- */

    /// È†ÅÈù¢ËºâÂÖ•ÂæåÂü∑Ë°å
    window.onload = function () {
        getNote(noteId);
    }

    /// Âà©Áî® noteId ÂèñÂæóÁ≠ÜË®òË≥áË®äËàáÂúñÁâá 
    async function getNote(noteId) {
        // === ËÆÄÂèñÁ≠ÜË®òË≥áË®ä
        var jsonObject;

        /*
        Input: 
            Á≠ÜË®ò ID
        Output: 
            Á≠ÜË®òÂêçÁ®±
            Á≠ÜË®òÊ®ôÁ±§
            Á≠ÜË®òÊïòËø∞
            Á≠ÜË®òÊôÇÈñì
            Á≠ÜË®òÊåâËÆöÊï∏
    
            Á≠ÜË®òÂúñÁâáÂêçÁ®±Èô£Âàó
    
            ‰ΩúËÄÖÁî®Êà∂ ID
        */
        await fetch(api_url + 'Note.do?NoteID=' + noteId + '&Account=' + currentUser, {
            mode: 'cors',
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
        })
            .then((response) => response.json())
            .then((data) => {
                jsonObject = {
                    'note_id': data['NoteInfo']['NoteData'][0]['NoteID'],
                    'note_name': data['NoteInfo']['NoteData'][0]['NoteName'],
                    'note_tag': data['NoteInfo']['NoteData'][0]['Tag'],
                    'note_description': data['NoteInfo']['NoteData'][0]['NoteDescription'],
                    'upload_time': data['NoteInfo']['NoteData'][0]['UploadTime'],
                    'like': data['NoteInfo']['NoteData'][0]['Like'],
                    'good': data['NoteInfo']['NoteData'][0]['good'],
                    'note_pic': data['PicUrl']['PicList'],
                    'author_id': data['NoteInfo']['NoteData'][0]['Account'],
                    'author_name': data['NoteInfo']['NoteData'][0]['Name'], 
                }

                console.log('%c # Note: \n' + JSON.stringify(jsonObject), 'color: green');

                commentList = data.Comment.CommentList.map((comment) => ({
                    // ÁïôË®ÄË≥áË®ä
                    'comment_id': comment['CommentID'],
                    'content': comment['Content'],
                    'time': comment['Time'],
                    'commenter_id': comment['Account'],
                    'commenter_name': comment['Name'],
                }));

                console.log('%c # Comment: \n' + commentList, 'color: green');

            })
            .catch((error) => {
                // Handle errors
                console.error('Error:', error);
            });

        // ÂÑ≤Â≠òÂúñÁâáÂàóË°®
        image_list = [''].concat(jsonObject['note_pic']);

        console.log('%c # Pic: \n' + image_list, 'color: green');

        // ÂÑ≤Â≠ò‰ΩúËÄÖ ID
        authorId = jsonObject['author_id'];

        // Êõ¥Êñ∞È†ÅÈù¢ÂÖßÂÆπ
        document.getElementById('note-name').innerHTML = jsonObject['note_name'];
        document.getElementById('note-description').innerHTML = jsonObject['note_description'];
        document.getElementById('note-tag').innerHTML = jsonObject['note_tag'];
        document.getElementById('note-upload-time').innerHTML = jsonObject['upload_time'];
        document.getElementById('note-like-count').innerHTML = jsonObject['like'];

        // Áî®Êà∂ÊåâÈÅéËÆö
        if (jsonObject['good'] == 1) {
            document.getElementById('icon-like').src = "./static/icon/icons8-favorite-filled-64.png";
        }
        // Áî®Êà∂Ê≤íÊåâËÆö
        else {
            document.getElementById('icon-like').src = "./static/icon/icons8-favorite-64.png";

        }

        // È†ÅÊï∏ÂàùÂßãÂåñ
        document.getElementById('note-current-page').innerHTML = current_page.toString();
        document.getElementById('note-total-page').innerHTML = (image_list.length - 1).toString();

        // === Êõ¥Êñ∞È†ÅÈù¢ÂÖßÂÆπ
        document.getElementById('pic-displayed').src = image_root + '/' + image_list[current_page];

        // Âè™ÊúâÂ∞ÅÈù¢
        if (jsonObject['note_pic'].length === 1) {
            document.getElementById('pic-prev').style.visibility = 'hidden';
            document.getElementById('pic-selected').src = image_root + '/' + image_list[current_page];
            document.getElementById('pic-next').style.visibility = 'hidden';
        }
        // Êõ¥Â§öÂúñÁâá
        else {
            document.getElementById('pic-prev').style.visibility = 'hidden';
            document.getElementById('pic-selected').src = image_root + '/' + image_list[current_page];
            document.getElementById('pic-next').src = image_root + '/' + image_list[current_page + 1];
        }

        // Êõ¥Êñ∞‰ΩúËÄÖÂÖßÂÆπ
        document.getElementById('user-name').innerHTML = jsonObject['author_name'];
        document.getElementById('author-profile').href = "./UserProfile.html?Account=" + authorId; 

        // Êñ∞Â¢ûÁïôË®ÄË≥áÊñô
        buildComment(commentList);
    }

    /// ÊòØÂê¶ÁÇ∫ÁïôË®ÄËÄÖ / ÁÆ°ÁêÜÂì°
    function IFCommentAdmin(commenterId) {
        // ÁïôË®ÄËÄÖÊú¨‰∫∫
        return currentUser === commenterId;
    }

    /// Âà©Áî® [JSONArray] commentList ÂèñÂæóÁõ∏ÈóúÁïôË®Ä
    function buildComment(commentList) {
        // Ëø¥ÂúàÂª∫Á´ãÂ≠êÂÖÉÁ¥†
        commentList.forEach((comment) => {
            var htmlElement;

            if (IFCommentAdmin(comment['commenter_id']) == true) {
                htmlElement =
                    [
                        '<div data-comment-id="' + comment['comment_id'] + '" style="box-sizing: border-box; width: 100%; display: flex; flex-direction: column; background-color: #D9D9D9;">',
                        '  <textarea style="font-size: 24px; resize: none; height: auto" disabled>' + comment['content'] + '</textarea>',

                        '  <div style="padding: 1vh 5vh 1vh 5vh; display: flex; flex-direction: row; justify-content: space-between;">',
                        '    <a href="./UserProfile.html?Account=' + comment['commenter_id'] + '" style="text-decoration: none; color: #4169E1; ">' + comment['commenter_name'] + '</a>',
                        // '    <span>' + comment['commenter_name'] + '</span>',
                        '    <div style="display: flex; flex-direction: row; justify-content: flex-end; align-items: center; gap: 1vw">',
                        '      <button class="delete-button" data-comment-id="' + comment['comment_id'] + '">Delete</button>',
                        '      <span>' + comment['time'] + '</span>',
                        '    </div>',
                        '  </div>',
                        '</div>',
                    ];
            }
            else {
                htmlElement =
                    [
                        '<div style="box-sizing: border-box; width: 100%; display: flex; flex-direction: column; background-color: #D9D9D9;">',
                        '  <textarea style="font-size: 24px; resize: none; height: auto" disabled>' + comment['content'] + '</textarea>',

                        '  <div style="padding: 1vh 5vh 1vh 5vh; display: flex; flex-direction: row; justify-content: space-between;">',
                        '    <a href="./UserProfile.html?Account=' + comment['commenter_id'] + '" style="text-decoration: none; color: #4169E1; ">' + comment['commenter_name'] + '</a>',
                        // '<span>' + comment['commenter_name'] + '</span>',
                        '    <div style="display: flex; flex-direction: row; justify-content: flex-end; align-items: center; gap: 1vw">',
                        '      <span>' + comment['time'] + '</span>',
                        '    </div>',
                        '  </div>',
                        '</div>',
                    ];
            }
            document.getElementById('comment-list').innerHTML += getHTML(htmlElement);
        });

        // Êõ¥Êñ∞ÁïôË®ÄÊï∏
        document.getElementById('note-comment-count').innerHTML = commentList.length;

        // EventListener -- Âà™Èô§ÊåâÈàï
        document.getElementById('comment-list').addEventListener('click', function (event) {
            if (event.target.classList.contains('delete-button')) {
                delComment(event.target.getAttribute('data-comment-id'));
            }
        });

    }

    /* ------------------------- Picture Page Controller ------------------------ */

    /// ‰∏ä‰∏ÄÈ†Å
    function prevPicture() {
        if (current_page > 1) {
            current_page -= 1; console.log('%c prev-page => ' + current_page, 'color: blue'); changeGallery(); document.getElementById('pic-next').style.visibility = 'visible';

            if (current_page == 1) {
                // hide <pic-prev>
                document.getElementById('pic-prev').style.visibility = 'hidden';
            }
        }
        else {
            console.log('%c üõë 1st-page', 'color: red');
        }
    }

    /// ‰∏ã‰∏ÄÈ†Å
    function nextPicture() {
        if (current_page == image_list.length - 1) {
            console.log('%c üõë last-page', 'color: red');
        }
        else {
            current_page += 1; console.log('%c next-page => ' + current_page, 'color: blue'); changeGallery(); document.getElementById('pic-prev').style.visibility = 'visible';

            if (current_page == image_list.length - 1) {
                // hide <pic-next>
                document.getElementById('pic-next').style.visibility = 'hidden';
            }
        }
    }

    /// ‰øÆÊîπÈ°ØÁ§∫ÂúñÁâá
    function changeGallery() {
        document.getElementById('note-current-page').innerHTML = current_page.toString();

        document.getElementById('pic-displayed').src = image_root + '/' + image_list[current_page];

        document.getElementById('pic-prev').src = image_root + '/' + image_list[current_page - 1];
        document.getElementById('pic-selected').src = image_root + '/' + image_list[current_page];
        document.getElementById('pic-next').src = image_root + '/' + image_list[current_page + 1];
    }

    /* ----------------------------- User Behaviour ----------------------------- */

    /// Êñ∞Â¢û‰∏¶‰∏äÂÇ≥ÁïôË®Ä
    async function addComment() {
        // ÁïôË®ÄÂÖßÂÆπ
        var content = document.getElementById('comment-input').value;

        // ÁÑ°Ëº∏ÂÖ• --> Do Nothing
        if (content == '') {
            document.getElementById('comment-input').placeholder = '! Ë´ãËº∏ÂÖ•ÊñáÂ≠ó';
        }
        // ÊúâËº∏ÂÖ• --> Update DB and Page
        else {
            // Ê∏ÖÁ©∫Á¥ÄÈåÑ
            document.getElementById('comment-input').value = '';

            var jsonObject;

            // ÁïôË®ÄÁöÑÂøÖÈ†àÂÄº
            var commentReq = {
                'NoteID': noteId,
                'Account': 'a',
                'Content': content,
            }

            /*
            ÂØ´ÂÖ•ÁïôË®ÄÂà∞ DB
            ------------
            Input: 
                Á≠ÜË®ò ID
                ÁïôË®ÄËÄÖÁî®Êà∂ ID
                ÁïôË®ÄÂÖßÂÆπ
            */
            await fetch(api_url + '/Comment.do', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(commentReq),
            }).then((response) => response.json())
                .then((data) => {
                    console.log('%c + New Comment\n' + JSON.stringify(commentReq), 'color: orange');

                    jsonObject =
                    {
                        // ÁïôË®Ä mysql ÁîüÊàêË≥áË®ä
                        'comment_id': data['response']['CommentID'],
                        'Name': data['response']['Name'],
                        'time': data['response']['Time'],
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });

            var htmlElement =
                [
                    '<div data-comment-id="' + jsonObject['comment_id'] + '" style="box-sizing: border-box; width: 100%; display: flex; flex-direction: column; background-color: #D9D9D9;">',
                    '<textarea style="font-size: 24px; resize: none; height: auto" disabled>' + commentReq['Content'] + '</textarea>',

                    '<div style="padding: 1vh 5vh 1vh 5vh; display: flex; flex-direction: row; justify-content: space-between;">',
                    '<span>' + jsonObject['Name'] + '</span>',
                    '<div style="display: flex; flex-direction: row; justify-content: flex-end; align-items: center; gap: 1vw">',
                    '<button class="delete-button" data-comment-id="' + jsonObject['comment_id'] + '">Delete</button>',
                    '<span>' + jsonObject['time'] + '</span>',
                    '</div>',
                    '</div>',
                    '</div>',
                ];

            // add to beginning
            document.getElementById('comment-list').insertAdjacentHTML('afterbegin', getHTML(htmlElement));

            document.querySelector('[data-comment-id="' + jsonObject['comment_id'] + '"]').addEventListener('click', function () { delComment(jsonObject['comment_id']); });

            // // Âº∑Âà∂Âà∑Êñ∞
            // window.location.reload();
        }
    }

    // Âà™Èô§ÁïôË®Ä
    async function delComment(comment_id) {
        await fetch(api_url + '/Comment.do', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ CommentID: comment_id, }),
        }).then(() => {
            console.log('%c - Delete Comment:' + comment_id, 'color: orange');

            document.querySelector('[data-comment-id="' + comment_id + '"]').remove();
        })
            .catch((error) => {
                console.error('Error:', error);
            });
    }

    /// Áî®Êà∂Êåâ / Êî∂ÂõûËÆö
    async function favorite() {
        // Áî®Êà∂Ê≤íÊåâÈÅéËÆö
        if (document.getElementById('icon-like').getAttribute('src') == "./static/icon/icons8-favorite-64.png") {
            document.getElementById('icon-like').src = "./static/icon/icons8-favorite-filled-64.png";
            document.getElementById('note-like-count').innerHTML = (parseInt(document.getElementById('note-like-count').innerText) + 1).toString();

            action = 'add';
        }
        // Áî®Êà∂Â∑≤ÊåâÈÅéËÆö
        else {
            document.getElementById('icon-like').src = "./static/icon/icons8-favorite-64.png";
            document.getElementById('note-like-count').innerHTML = (parseInt(document.getElementById('note-like-count').innerText) - 1).toString();

            action = 'minus';
        }

        console.log(JSON.stringify({ note_id: noteId, user_id: currentUser, Like: 1 }));

        /*
        Êõ¥Êñ∞ÊåâËÆöÁî®Êà∂Ê∏ÖÂñÆ
        ---------------
        Input: 
            Á≠ÜË®ò ID
            ÊåâËÆöÁî®Êà∂ ID
        */
        await fetch(api_url + '/Note.do', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ NoteID: noteId, Account: currentUser, Like: 1 })
        })
            .catch((error) => {
                console.error('Error:', error);
            });
    }
</script>

</html>